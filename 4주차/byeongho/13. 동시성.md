# 동시성

## 동시성의 필요성

동시성은 결합(무엇, 언제)를 분리하는 전략이다. 이를 분리하면 애플리케이션 구조와 효율이 극적으로 좋아진다.

## 동시성 방어 원칙
### SRP - 단일 책임 원칙

- SRP : 주어진 메서드, 클래스를 변경할 이유가 하나여야 한다는 원칙
- 동시성 관련 코드는 다른 코드와 분리되어야 한다.


### 자료 범위 제한

- 공유 객체를 사용하는 코드에서는 임계영역을 `synchroinized` 키워드를 통해 보호한다.

> 자료를 캡슐화하고 공유되는 자료를 줄인다.

### 자료 사본의 사용

처음부터 공유하지 않는 것이 제일 베스트이다.

- 객체를 복사해 읽기 전용으로 사용한다.
- 객체를 복사하는 비용과 공유 자원 동기화 비용을 실측하여 효율적인 방안을 잡아야 한다.

### 스레드의 독리벚ㄱ 구현

다른 스레드와 자료를 공유하지 않는 독립적인 스레드를 구현해야한다. 각 스레드는 클라이언트 요청을 하나씩만 처리해야 한다.

## 라이브러리의 적극 활용

`java.util.concurrent` 패키지가 제공하는 클래스는 다중 스레드 환경에서 사용해도 안전하고 성능이 좋다. 이러한 라이브러리를 적극 활용하는 것이 좋다.

## 실행 모델의 이해

다중 스레드에서 나요는 용어들은 다음이 존재한다.
- 한정된 자원 (Bound Resource)
- 상호 배제 (Mutual Exclusion)
- 기아 (Starvation)
- 데드락 (Deadlock)
- 라이브락 (Livelock)

다음의 실행 모델 또한 존재한다.

- 생선자 - 소비자
- 읽기 - 쓰기
- 식사하는 철학자들

이러한 실행 모델과 용어들에 대한 이해를 통해 동시성에 대한 대처를 진행해야 한다.

## 동기화하는 메서드 사이에 존재하는 의존성을 이해하자.

동기화하는 메서드 사이에 의존성이 존재하면 동시성 코드에서 찾아내기 어려운 버그가 생긴다. 해당 의존성을 최대한 이해해야하지만 이러한 메서드가 여럿이면 이를 이해하기 어려울 수 있기에 최대한 공유 객체 하나에는 메서드 하나만 사용하도록 권장한다.

## 동기화하는 부분을 작게 생성

최대한 `synchronoized`와 임계영역 수를 줄여야한다.

- `synchronized` : 락을 생성하는 이는 스레드를 지연시키고 부하를 가중시킨다.
- 임계영역 수 : 임계영역 크기를 키우는 경우 스레드 간 경쟁이 늘어난고 프로그램 성능이 떨어진다.

## 올바른 종료 코드의 구현 어려움

다중 스레드의 경우 데드락의 문제로 인해 올바른 종료가 이루어지기 어려울 수 있다. 그렇기에 종료 코드를 개발 초기부터 고민하고 초기부터 시간투자하여 완벽히 구현해야 한다.


## 스레드 코드 테스트

스레드가 많아지는 것은 고려할 사항이 아주 많아진다. 이를 위해 다음의 지침을 제시한다.

- 말이 안 되는 실패는 스레드 문제로 취급
- 다중 스레드를 고려하지 않은 순차 코드부터 제대로 테스트
- 다중 스레드를 쓰는 코드 부부능ㄹ 다양한 환경에 넣을 수 있도록 구현
- 다중 스레드를 쓰는 코드를 상황에 맞춰 조정가능하게 작성
- 프로세서 수보다 많은 스레드 돌려보기
- 다른 플랫폼에서 돌리기
- 강제로 실패를 일으키기

총체적으로 문제를 노출하는 테스트 케이스를 작성하고 프로그램 설정과 시스템 설정, 부하를 바꿔가며 최대한 에러를 발생시키며 테스틏한다.